<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreamento em Tempo Real - Motoboy Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .motoboy-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .motoboy-id {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .map-container {
            height: calc(100vh - 200px);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 250px;
            z-index: 1000;
        }

        .info-panel h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            font-weight: bold;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .last-update {
            font-size: 0.8em;
            color: #666;
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            background: #f8d7da;
            margin: 20px;
            border-radius: 10px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            z-index: 1001;
        }

        .back-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚Üê Voltar</a>
    
    <div class="header">
        <h1> Rastreamento em Tempo Real</h1>
        <p>Acompanhe a localiza√ß√£o do motoboy em tempo real</p>
    </div>

    <div class="controls">
        <div class="motoboy-info">
            <div class="motoboy-id" id="motoboyId">Carregando...</div>
            <div class="status inactive" id="status">Desconectado</div>
        </div>
        <button class="refresh-btn" onclick="refreshLocation()">üîÑ Atualizar</button>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>üìä Informa√ß√µes</h3>
            <div class="info-item">
                <span class="info-label">Latitude:</span>
                <span class="info-value" id="latitude">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Longitude:</span>
                <span class="info-value" id="longitude">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Precis√£o:</span>
                <span class="info-value" id="accuracy">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Velocidade:</span>
                <span class="info-value" id="speed">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Od√¥metro:</span>
                <span class="info-value" id="odometer">-</span>
            </div>
            <div class="last-update" id="lastUpdate">
                √öltima atualiza√ß√£o: Nunca
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const motoboyId = urlParams.get('id');
        
        if (!motoboyId) {
            document.body.innerHTML = '<div class="error"><h2>‚ùå Erro</h2><p>ID do motoboy n√£o fornecido</p><a href="index.html">Voltar</a></div>';
        }

        // Configura√ß√µes
        const API_BASE = '/api';
        let map;
        let motoboyMarker;
        let motoboyCircle;
        let refreshInterval;

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-23.5505, -46.6333], 13); // S√£o Paulo como padr√£o
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Atualizar informa√ß√µes do motoboy
        function updateMotoboyInfo() {
            document.getElementById('motoboyId').textContent = motoboyId;
        }

        // Buscar localiza√ß√£o atual do motoboy
        async function fetchMotoboyLocation() {
            try {
                const response = await fetch(`${API_BASE}/locations?motoboyId=${motoboyId}&limit=1`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const location = data.data[0];
                    updateLocationOnMap(location);
                    updateInfoPanel(location);
                    updateStatus('active');
                } else {
                    updateStatus('inactive');
                }
            } catch (error) {
                console.error('Erro ao buscar localiza√ß√£o:', error);
                updateStatus('inactive');
            }
        }

        // Atualizar localiza√ß√£o no mapa
        function updateLocationOnMap(location) {
            const lat = parseFloat(location.latitude);
            const lng = parseFloat(location.longitude);
            const accuracy = parseFloat(location.accuracy) || 10;

            // Remover marcador anterior
            if (motoboyMarker) {
                map.removeLayer(motoboyMarker);
            }
            if (motoboyCircle) {
                map.removeLayer(motoboyCircle);
            }

            // Criar novo marcador
            motoboyMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'motoboy-marker',
                    html: 'üèçÔ∏è',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);

            // Criar c√≠rculo de precis√£o
            motoboyCircle = L.circle([lat, lng], {
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.2,
                radius: accuracy
            }).addTo(map);

            // Centralizar mapa na localiza√ß√£o
            map.setView([lat, lng], 15);
        }

        // Atualizar painel de informa√ß√µes
        function updateInfoPanel(location) {
            document.getElementById('latitude').textContent = location.latitude.toFixed(6);
            document.getElementById('longitude').textContent = location.longitude.toFixed(6);
            document.getElementById('accuracy').textContent = `${(location.accuracy || 0).toFixed(1)}m`;
            document.getElementById('speed').textContent = location.speed ? `${(location.speed * 3.6).toFixed(1)} km/h` : '-';
            document.getElementById('odometer').textContent = location.odometer ? `${location.odometer} km` : '-';
            
            const updateTime = new Date(location.timestamp);
            document.getElementById('lastUpdate').textContent = 
                `√öltima atualiza√ß√£o: ${updateTime.toLocaleString('pt-BR')}`;
        }

        // Atualizar status
        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${status}`;
            statusElement.textContent = status === 'active' ? 'Conectado' : 'Desconectado';
        }

        // Atualizar localiza√ß√£o
        function refreshLocation() {
            fetchMotoboyLocation();
        }

        // Inicializar p√°gina
        function init() {
            initMap();
            updateMotoboyInfo();
            fetchMotoboyLocation();
            
            // Atualizar a cada 10 segundos
            refreshInterval = setInterval(fetchMotoboyLocation, 10000);
        }

        // Iniciar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);

        // Limpar intervalo quando sair da p√°gina
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
